import React, { useState, useEffect, useCallback, useMemo } from 'react';

// Firebase Imports
// Make sure you have firebase installed in your project: npm install firebase
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut,
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  doc,
  onSnapshot,
  addDoc,
  setDoc,
  deleteDoc,
} from 'firebase/firestore';
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL,
} from 'firebase/storage';

// --- Firebase Configuration ---
// User-provided Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCePcVE_BTiFuYXAApNmbMKHdkhQ9Ay_F4",
  authDomain: "al-ambar-perfume-company.firebaseapp.com",
  projectId: "al-ambar-perfume-company",
  storageBucket: "al-ambar-perfume-company.firebasestorage.app",
  messagingSenderId: "992506041633",
  appId: "1:992506041633:web:f7277461a577248bb8da60",
  measurementId: "G-39XB0WLW6P"
};

// This app ID is used for creating unique database paths
const appId = typeof __app_id !== 'undefined' ? __app_id : 'al-ambar-perfume-company';

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- Database Paths ---
// These paths use the appId to namespace your data in Firestore
const settingsPath = `/artifacts/${appId}/public/data/settings/main`;
const categoriesPath = `/artifacts/${appId}/public/data/categories`;
const productsPath = `/artifacts/${appId}/public/data/products`;
const mediaBasePath = `artifacts/${appId}/public/media`;

// --- Reusable File Upload Hook ---
const useFileUpload = () => {
  const [isUploading, setIsUploading] = useState(false);
  const [error, setError] = useState(null);

  const uploadFile = useCallback(async (file) => {
    if (!file) return null;

    setIsUploading(true);
    setError(null);

    try {
      const storageRef = ref(storage, `${mediaBasePath}/${Date.now()}_${file.name}`);
      const snapshot = await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(snapshot.ref);
      setIsUploading(false);
      return downloadURL;
    } catch (err) {
      console.error("File upload error:", err);
      setError(err.message || "Could not upload file.");
      setIsUploading(false);
      return null;
    }
  }, []);

  return { isUploading, error, uploadFile };
};

// --- Helper Functions ---
const getYouTubeEmbedUrl = (url) => {
  if (!url) return null;
  let videoId = null;
  try {
    const urlObj = new URL(url);
    if (urlObj.hostname === 'youtu.be') {
      videoId = urlObj.pathname.slice(1);
    } else if (urlObj.hostname.includes('youtube.com')) {
      videoId = urlObj.searchParams.get('v');
    }
    return videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0&modestbranding=1&playsinline=1` : null;
  } catch (e) {
    console.warn("Invalid video URL:", url);
    return null;
  }
};

// --- Main App Component ---
export default function App() {
  // --- State ---
  const [currentPage, setCurrentPage] = useState('home');
  const [user, setUser] = useState(null); // Admin user
  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);

  // --- Data State ---
  const [siteSettings, setSiteSettings] = useState({});
  const [categories, setCategories] = useState([]);
  const [products, setProducts] = useState([]);
  
  // --- Navigation State ---
  const [selectedProductId, setSelectedProductId] = useState(null);
  const [selectedCategory, setSelectedCategory] = useState(null);
  
  // --- Effects ---

  // Auth Effect: Listen for admin login state
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setIsAdmin(!!currentUser);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Settings Effect: Listen for site settings
  useEffect(() => {
    const docRef = doc(db, settingsPath);
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        setSiteSettings(docSnap.data());
      } else {
        console.log("No site settings found. Admin should create them.");
      }
    });
    return () => unsubscribe();
  }, []);

  // Categories Effect: Listen for categories
  useEffect(() => {
    const collRef = collection(db, categoriesPath);
    const unsubscribe = onSnapshot(collRef, (snapshot) => {
      const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setCategories(cats);
    });
    return () => unsubscribe();
  }, []);

  // Products Effect: Listen for products
  useEffect(() => {
    const collRef = collection(db, productsPath);
    const unsubscribe = onSnapshot(collRef, (snapshot) => {
      const prods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setProducts(prods);
    });
    return () => unsubscribe();
  }, []);

  // --- Navigation ---
  const navigateTo = (page, { productId = null, categoryId = null } = {}) => {
    setSelectedProductId(productId);
    setSelectedCategory(categoryId);
    setCurrentPage(page);
    window.scrollTo(0, 0); // Scroll to top on page change
  };

  // --- Event Handlers ---
  const handleAdminLogin = async (email, password) => {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      navigateTo('adminDashboard');
    } catch (error) {
      console.error("Admin login failed:", error);
      return error.message;
    }
  };

  const handleAdminLogout = async () => {
    await signOut(auth);
    navigateTo('home');
  };

  // --- Derived State ---
  const currentProduct = useMemo(() => {
    return products.find(p => p.id === selectedProductId);
  }, [products, selectedProductId]);

  const filteredProducts = useMemo(() => {
    if (!selectedCategory) return products;
    return products.filter(p => p.categoryId === selectedCategory);
  }, [products, selectedCategory]);

  const whatsappNumber = siteSettings.whatsappNumber || "1234567890"; // Fallback

  // --- Page Routing ---
  const renderPage = () => {
    if (loading) {
      return <LoadingSpinner />;
    }
    
    switch (currentPage) {
      case 'home':
        return <HomePage 
                  siteSettings={siteSettings} 
                  categories={categories} 
                  products={products.filter(p => p.isFeatured)} 
                  navigateTo={navigateTo} 
                />;
      case 'products':
        return <ProductListPage 
                  products={filteredProducts} 
                  categories={categories}
                  selectedCategory={selectedCategory}
                  navigateTo={navigateTo} 
                  setSelectedCategory={setSelectedCategory}
                />;
      case 'productDetail':
        return <ProductDetailPage 
                  product={currentProduct} 
                  whatsappNumber={whatsappNumber}
                />;
      case 'contact':
        return <ContactPage siteSettings={siteSettings} />;
      case 'adminLogin':
        return <AdminLoginPage onLogin={handleAdminLogin} />;
      case 'adminDashboard':
        return isAdmin ? (
          <AdminDashboard 
            siteSettings={siteSettings}
            categories={categories}
            products={products}
          />
        ) : <AdminLoginPage onLogin={handleAdminLogin} />;
      default:
        return <HomePage 
                  siteSettings={siteSettings} 
                  categories={categories} 
                  products={products.filter(p => p.isFeatured)} 
                  navigateTo={navigateTo} 
                />;
    }
  };
  
  return (
    <div className="font-sans bg-white min-h-screen text-gray-900">
      <Header siteSettings={siteSettings} navigateTo={navigateTo} isAdmin={isAdmin} />
      <main className="pt-20"> {/* Offset for sticky header */}
        {renderPage()}
      </main>
      <WhatsAppButton whatsappNumber={whatsappNumber} />
      <Footer siteSettings={siteSettings} />
    </div>
  );
}

// --- UI Components ---

const Header = ({ siteSettings, navigateTo, isAdmin }) => (
  <header className="bg-gray-900 text-white p-4 fixed top-0 left-0 right-0 z-50 shadow-lg">
    <div className="container mx-auto flex justify-between items-center">
      <div 
        className="flex items-center space-x-3 cursor-pointer"
        onClick={() => navigateTo('home')}
      >
        <img 
          src={siteSettings.logoUrl || 'https://placehold.co/100x100/1a202c/amber-400?text=A'} 
          alt="Al Ambar Logo" 
          className="h-12 w-12 rounded-full object-cover border-2 border-amber-400"
        />
        <span className="text-2xl font-bold text-amber-400 tracking-wider">
          {siteSettings.siteName || "Al Ambar"}
        </span>
      </div>
      <nav className="hidden md:flex space-x-6 items-center">
        <NavItem onClick={() => navigateTo('home')}>Home</NavItem>
        <NavItem onClick={() => navigateTo('products')}>Products</NavItem>
        <NavItem onClick={() => navigateTo('contact')}>Contact</NavItem>
        <button
          onClick={() => navigateTo(isAdmin ? 'adminDashboard' : 'adminLogin')}
          className="bg-amber-400 text-gray-900 px-4 py-2 rounded-lg font-semibold hover:bg-amber-300 transition-colors"
        >
          {isAdmin ? 'Dashboard' : 'Admin'}
        </button>
      </nav>
      {/* Mobile nav could be added here */}
    </div>
  </header>
);

const NavItem = ({ onClick, children }) => (
  <button 
    onClick={onClick}
    className="text-lg font-medium text-white hover:text-amber-400 transition-colors"
  >
    {children}
  </button>
);

const Footer = ({ siteSettings }) => (
  <footer className="bg-gray-900 text-amber-300 p-10 mt-16">
    <div className="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
      <div>
        <h3 className="text-xl font-bold text-white mb-4">Al Ambar Perfumes</h3>
        <p className="text-gray-300">{siteSettings.tagline || "The essence of luxury."}</p>
      </div>
      <div>
        <h3 className="text-xl font-bold text-white mb-4">Quick Links</h3>
        <ul className="space-y-2">
          <li><a href="#" className="hover:text-white">Home</a></li>
          <li><a href="#" className="hover:text-white">Products</a></li>
          <li><a href="#" className="hover:text-white">Contact</a></li>
        </ul>
      </div>
      <div>
        <h3 className="text-xl font-bold text-white mb-4">Follow Us</h3>
        <div className="flex justify-center md:justify-start space-x-4">
          {/* Add social media icons here */}
          <span className="text-gray-300">Facebook</span>
          <span className="text-gray-300">Instagram</span>
        </div>
        <p className="text-gray-400 mt-4">© {new Date().getFullYear()} Al Ambar. All rights reserved.</p>
      </div>
    </div>
  </footer>
);

const WhatsAppButton = ({ whatsappNumber }) => (
  <a
    href={`https://wa.me/${whatsappNumber}?text=${encodeURIComponent("Hello Al Ambar, I have a question.")}`}
    target="_blank"
    rel="noopener noreferrer"
    className="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-lg z-40 hover:bg-green-600 transition-transform hover:scale-110"
    aria-label="Chat on WhatsApp"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-8 h-8">
      <path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2ZM12.04 20.13C10.5 20.13 9.01 19.7 7.7 18.91L7.29 18.67L4.93 19.3L5.61 17.02L5.36 16.6C4.48 15.25 4 13.63 4 11.91C4 7.39 7.6 3.79 12.04 3.79C16.48 3.79 20.1 7.39 20.1 11.91C20.1 16.43 16.48 20.13 12.04 20.13ZM17.36 14.33C17.13 14.22 15.68 13.51 15.42 13.41C15.17 13.3 15 13.25 14.83 13.5C14.67 13.76 14.12 14.43 13.93 14.64C13.74 14.85 13.55 14.88 13.29 14.77C13.04 14.66 12.03 14.31 10.83 13.21C9.89 12.33 9.29 11.23 9.13 10.97C8.96 10.71 9.08 10.59 9.22 10.45C9.35 10.33 9.5 10.15 9.63 10C9.76 9.85 9.81 9.73 9.9 9.57C9.99 9.41 9.94 9.25 9.86 9.14C9.79 9.03 9.25 7.68 9.03 7.14C8.81 6.6 8.59 6.65 8.42 6.64C8.25 6.64 8.08 6.64 7.91 6.64C7.74 6.64 7.48 6.7 7.26 6.91C7.03 7.12 6.51 7.6 6.51 8.68C6.51 9.75 7.29 10.78 7.41 10.93C7.54 11.09 9.02 13.48 11.3 14.46C11.83 14.69 12.21 14.84 12.49 14.96C12.98 15.15 13.41 15.13 13.78 15.05C14.2 14.96 15.42 14.3 15.68 14.16C15.93 14.03 16.1 13.98 16.22 14.1C16.34 14.22 16.92 14.79 17.1 14.97C17.28 15.15 17.46 15.2 17.36 15.1C17.36 14.33 17.13 14.22 17.36 14.33Z" />
    </svg>
  </a>
);

const LoadingSpinner = () => (
  <div className="flex justify-center items-center h-screen">
    <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-amber-500"></div>
  </div>
);

// --- Page Components ---

const HomePage = ({ siteSettings, categories, products, navigateTo }) => {
  const embedUrl = getYouTubeEmbedUrl(siteSettings.videoUrl);

  return (
    <div className="space-y-24">
      {/* 1. Video Section */}
      {siteSettings.videoUrl && (
        <section className="relative h-[70vh] w-full overflow-hidden bg-gray-900">
          {embedUrl ? (
            <iframe
              src={embedUrl}
              frameBorder="0"
              allow="autoplay; encrypted-media"
              allowFullScreen
              className="absolute top-0 left-0 w-full h-full"
            ></iframe>
          ) : (
            <video
              src={siteSettings.videoUrl}
              autoPlay
              muted
              loop
              playsInline
              className="absolute top-1/2 left-1/2 min-w-full min-h-full w-auto h-auto object-cover -translate-x-1/2 -translate-y-1/2"
            />
          )}
          <div className="absolute inset-0 bg-black bg-opacity-40 flex flex-col justify-center items-center text-center text-white p-4">
            <h1 className="text-5xl md:text-7xl font-bold text-amber-300 drop-shadow-lg">
              {siteSettings.siteName || "Al Ambar Perfumes"}
            </h1>
            <p className="text-xl md:text-2xl mt-4 max-w-2xl drop-shadow-md">
              {siteSettings.tagline || "Discover the essence of luxury and tradition."}
            </p>
          </div>
        </section>
      )}

      {/* 2. Category Highlights */}
      <section className="container mx-auto px-4">
        <h2 className="text-4xl font-bold text-center mb-12">Our Collections</h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8">
          {categories.map(cat => (
            <div
              key={cat.id}
              onClick={() => navigateTo('products', { categoryId: cat.id })}
              className="group cursor-pointer aspect-square rounded-lg shadow-xl overflow-hidden relative"
            >
              <img 
                src={cat.imageUrl || 'https://placehold.co/300x300/1a202c/amber-400?text=Category'} 
                alt={cat.name}
                className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
              />
              <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <h3 className="text-white text-2xl font-semibold">{cat.name}</h3>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* 3. Featured Perfumes */}
      <section className="container mx-auto px-4">
        <h2 className="text-4xl font-bold text-center mb-12">Featured Products</h2>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
          {products.map(product => (
            <ProductCard 
              key={product.id} 
              product={product} 
              onClick={() => navigateTo('productDetail', { productId: product.id })}
            />
          ))}
        </div>
      </section>
    </div>
  );
};

const ProductCard = ({ product, onClick }) => (
  <div 
    onClick={onClick} 
    className="bg-white rounded-lg shadow-lg overflow-hidden group cursor-pointer transition-all duration-300 hover:shadow-2xl"
  >
    <div className="aspect-square overflow-hidden">
      <img 
        src={product.imageUrl || 'https://placehold.co/400x400/eeeeee/1a202c?text=Perfume'} 
        alt={product.name}
        className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
      />
    </div>
    <div className="p-5 text-center">
      <h3 className="text-xl font-semibold text-gray-900 truncate">{product.name}</h3>
      <p className="text-lg text-amber-600 font-bold mt-2">₹{product.price}</p>
    </div>
  </div>
);

const ProductListPage = ({ products, categories, selectedCategory, navigateTo, setSelectedCategory }) => (
  <div className="container mx-auto px-4 min-h-[60vh]">
    <h1 className="text-4xl font-bold text-center my-12">Our Products</h1>
    
    {/* Category Filter */}
    <div className="flex justify-center flex-wrap gap-4 mb-12">
      <button 
        onClick={() => setSelectedCategory(null)}
        className={`px-6 py-2 rounded-full font-semibold transition-colors ${!selectedCategory ? 'bg-gray-900 text-amber-400' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
      >
        All
      </button>
      {categories.map(cat => (
        <button
          key={cat.id}
          onClick={() => setSelectedCategory(cat.id)}
          className={`px-6 py-2 rounded-full font-semibold transition-colors ${selectedCategory === cat.id ? 'bg-gray-900 text-amber-400' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
        >
          {cat.name}
        </button>
      ))}
    </div>
    
    {/* Product Grid */}
    {products.length > 0 ? (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        {products.map(product => (
          <ProductCard 
            key={product.id} 
            product={product} 
            onClick={() => navigateTo('productDetail', { productId: product.id })}
          />
        ))}
      </div>
    ) : (
      <p className="text-center text-xl text-gray-500">No products found in this category.</p>
    )}
  </div>
);

const ProductDetailPage = ({ product, whatsappNumber }) => {
  if (!product) {
    return (
      <div className="container mx-auto px-4 py-12 text-center min-h-[60vh]">
        <h1 className="text-3xl">Product not found.</h1>
      </div>
    );
  }

  const message = `Hi Al Ambar, I would like to order: ${product.name} (Price: ₹${product.price}). Product ID: ${product.id}`;
  const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

  return (
    <div className="container mx-auto px-4 py-12">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
        {/* Image */}
        <div className="rounded-lg shadow-xl overflow-hidden aspect-square">
          <img 
            src={product.imageUrl || 'https://placehold.co/600x600/eeeeee/1a202c?text=Perfume'} 
            alt={product.name}
            className="w-full h-full object-cover"
          />
        </div>
        
        {/* Details */}
        <div className="flex flex-col h-full pt-4">
          <h1 className="text-4xl md:text-5xl font-bold text-gray-900">{product.name}</h1>
          <p className="text-4xl text-amber-600 font-bold my-6">₹{product.price}</p>
          
          <div className="prose prose-lg max-w-none text-gray-700 mb-8">
            <p>{product.description}</p>
            {/* You can add more fields like notes, lasting, etc. here */}
          </div>

          <div className="mt-auto">
            <a
              href={whatsappUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center justify-center w-full bg-green-500 text-white text-xl font-bold px-8 py-4 rounded-lg shadow-md hover:bg-green-600 transition-colors"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 mr-3">
                <path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2ZM12.04 20.13C10.5 20.13 9.01 19.7 7.7 18.91L7.29 18.67L4.93 19.3L5.61 17.02L5.36 16.6C4.48 15.25 4 13.63 4 11.91C4 7.39 7.6 3.79 12.04 3.79C16.48 3.79 20.1 7.39 20.1 11.91C20.1 16.43 16.48 20.13 12.04 20.13ZM17.36 14.33C17.13 14.22 15.68 13.51 15.42 13.41C15.17 13.3 15 13.25 14.83 13.5C14.67 13.76 14.12 14.43 13.93 14.64C13.74 14.85 13.55 14.88 13.29 14.77C13.04 14.66 12.03 14.31 10.83 13.21C9.89 12.33 9.29 11.23 9.13 10.97C8.96 10.71 9.08 10.59 9.22 10.45C9.35 10.33 9.5 10.15 9.63 10C9.76 9.85 9.81 9.73 9.9 9.57C9.99 9.41 9.94 9.25 9.86 9.14C9.79 9.03 9.25 7.68 9.03 7.14C8.81 6.6 8.59 6.65 8.42 6.64C8.25 6.64 8.08 6.64 7.91 6.64C7.74 6.64 7.48 6.7 7.26 6.91C7.03 7.12 6.51 7.6 6.51 8.68C6.51 9.75 7.29 10.78 7.41 10.93C7.54 11.09 9.02 13.48 11.3 14.46C11.83 14.69 12.21 14.84 12.49 14.96C12.98 15.15 13.41 15.13 13.78 15.05C14.2 14.96 15.42 14.3 15.68 14.16C15.93 14.03 16.1 13.98 16.22 14.1C16.34 14.22 16.92 14.79 17.1 14.97C17.28 15.15 17.46 15.2 17.36 15.1C17.36 14.33 17.13 14.22 17.36 14.33Z" />
              </svg>
              Order on WhatsApp
            </a>
          </div>
        </div>
      </div>
    </div>
  );
};

const ContactPage = ({ siteSettings }) => (
  <div className="container mx-auto px-4 py-12 min-h-[60vh]">
    <h1 className="text-4xl font-bold text-center mb-12">Contact Us</h1>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
      <div className="bg-gray-50 p-8 rounded-lg shadow-lg">
        <h2 className="text-2xl font-semibold mb-6">Get in Touch</h2>
        <div className="space-y-4">
          <p className="flex items-center text-lg">
            <b className="w-24">WhatsApp:</b>
            <a href={`https://wa.me/${siteSettings.whatsappNumber}`} className="text-amber-600 hover:underline">{siteSettings.whatsappNumber || 'N/A'}</a>
          </p>
          <p className="flex items-center text-lg">
            <b className="w-24">Phone:</b>
            <span className="text-gray-800">{siteSettings.phone || 'N/A'}</span>
          </p>
          <p className="flex items-center text-lg">
            <b className="w-24">Email:</b>
            <span className="text-gray-800">{siteSettings.email || 'N/A'}</span>
          </p>
          <p className="flex items-start text-lg">
            <b className="w-24 shrink-0">Address:</b>
            <span className="text-gray-800">{siteSettings.address || 'Come visit us!'}</span>
          </p>
        </div>
      </div>
      <div className="rounded-lg shadow-lg overflow-hidden">
        <iframe 
          src={siteSettings.mapEmbedUrl || "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3960.902837392275!2d79.8589025152348!3d6.90222099501237!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3ae2596311955555%3A0x546c34cd99f6f488!2sColombo%2C%2Sri%20Lanka!5e0!3m2!1sen!2sus!4v1678888888888!5m2!1sen!2sus"} 
          width="100%" 
          height="450" 
          style={{ border:0 }} 
          allowFullScreen="" 
          loading="lazy" 
          referrerPolicy="no-referrer-when-downgrade"
        ></iframe>
      </div>
    </div>
  </div>
);

// --- Admin Components ---

const AdminLoginPage = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    const errorMessage = await onLogin(email, password);
    if (errorMessage) {
      setError(errorMessage);
    }
  };

  return (
    <div className="flex justify-center items-center min-h-[70vh] bg-gray-100">
      <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
        <h2 className="text-3xl font-bold text-center mb-6">Admin Login</h2>
        {error && <p className="text-red-500 text-center mb-4">{error}</p>}
        <div className="mb-4">
          <label className="block text-gray-700 mb-2" htmlFor="email">Email</label>
          <input
            type="email"
            id="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full px-3 py-2 border rounded-lg"
            required
          />
        </div>
        <div className="mb-6">
          <label className="block text-gray-700 mb-2" htmlFor="password">Password</label>
          <input
            type="password"
            id="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full px-3 py-2 border rounded-lg"
            required
          />
        </div>
        <button type="submit" className="w-full bg-gray-900 text-amber-400 py-3 rounded-lg font-bold hover:bg-gray-800">
          Login
        </button>
      </form>
    </div>
  );
};

// Admin Dashboard
const AdminDashboard = ({ siteSettings, categories, products }) => {
  const [currentTab, setCurrentTab] = useState('settings');
  
  const handleLogout = async () => {
    await signOut(auth);
  };
  
  const renderTabContent = () => {
    switch(currentTab) {
      case 'settings':
        return <SettingsManager currentSettings={siteSettings} />;
      case 'categories':
        return <CategoryManager categories={categories} />;
      case 'products':
        return <ProductManager products={products} categories={categories} />;
      default:
        return null;
    }
  };

  return (
    <div className="container mx-auto px-4 py-12">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-4xl font-bold">Admin Dashboard</h1>
        <button
          onClick={handleLogout}
          className="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700"
        >
          Sign Out
        </button>
      </div>
      
      <div className="flex border-b mb-8">
        <AdminTab title="Site Settings" id="settings" currentTab={currentTab} setCurrentTab={setCurrentTab} />
        <AdminTab title="Categories" id="categories" currentTab={currentTab} setCurrentTab={setCurrentTab} />
        <AdminTab title="Products" id="products" currentTab={currentTab} setCurrentTab={setCurrentTab} />
      </div>
      
      <div>
        {renderTabContent()}
      </div>
    </div>
  );
};

const AdminTab = ({ title, id, currentTab, setCurrentTab }) => (
  <button
    onClick={() => setCurrentTab(id)}
    className={`px-6 py-3 font-semibold ${currentTab === id ? 'border-b-2 border-amber-500 text-amber-600' : 'text-gray-500 hover:text-gray-800'}`}
  >
    {title}
  </button>
);

const AdminInput = React.forwardRef(({ label, id, ...props }, ref) => (
  <div className="mb-4">
    <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor={id}>{label}</label>
    <input 
      ref={ref}
      id={id}
      {...props}
      className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"
    />
  </div>
));

const AdminTextarea = ({ label, id, ...props }) => (
  <div className="mb-4">
    <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor={id}>{label}</label>
    <textarea 
      id={id}
      {...props}
      rows="4"
      className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"
    />
  </div>
);

const AdminButton = ({ children, onClick, type = "button", isLoading = false, variant = "primary" }) => {
  const colors = {
    primary: "bg-gray-900 text-amber-400 hover:bg-gray-800",
    danger: "bg-red-600 text-white hover:bg-red-700",
  };
  
  return (
    <button
      type={type}
      onClick={onClick}
      disabled={isLoading}
      className={`px-6 py-3 rounded-lg font-bold transition-colors ${colors[variant]} ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
    >
      {isLoading ? 'Saving...' : children}
    </button>
  );
};

// Settings Manager
const SettingsManager = ({ currentSettings }) => {
  const [formState, setFormState] = useState(currentSettings);
  const [logoFile, setLogoFile] = useState(null);
  const [videoFile, setVideoFile] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [message, setMessage] = useState('');
  const { uploadFile, isUploading } = useFileUpload();

  useEffect(() => {
    setFormState(currentSettings);
  }, [currentSettings]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormState(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSaving(true);
    setMessage('');
    let dataToSave = { ...formState };
    
    try {
      if (logoFile) {
        const logoUrl = await uploadFile(logoFile);
        if (logoUrl) dataToSave.logoUrl = logoUrl;
      }
      
      if (videoFile) {
        const videoUrl = await uploadFile(videoFile);
        if (videoUrl) dataToSave.videoUrl = videoUrl;
      }
      
      await setDoc(doc(db, settingsPath), dataToSave, { merge: true });
      setMessage('Settings saved successfully!');
    } catch (err) {
      console.error(err);
      setMessage('Error saving settings.');
    }
    
    setIsSaving(false);
  };

  return (
    <form onSubmit={handleSubmit} className="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
      <h2 className="text-2xl font-semibold mb-6">Branding & Site Settings</h2>
      {message && <p className="text-green-600 mb-4">{message}</p>}
      
      <AdminInput label="Site Name" id="siteName" name="siteName" value={formState.siteName || ''} onChange={handleChange} />
      <AdminInput label="Tagline" id="tagline" name="tagline" value={formState.tagline || ''} onChange={handleChange} />
      
      <div className="mb-4">
        <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="logo">Logo</label>
        <input type="file" id="logo" onChange={(e) => setLogoFile(e.target.files[0])} className="w-full" />
        {currentSettings.logoUrl && <img src={currentSettings.logoUrl} alt="Current Logo" className="w-24 h-24 mt-2 rounded-full object-cover" />}
      </div>
      
      <AdminInput label="Homepage Video URL (YouTube or Direct Link)" id="videoUrl" name="videoUrl" value={formState.videoUrl || ''} onChange={handleChange} placeholder="https://youtube.com/watch?v=... OR" />
      <div className="mb-4">
        <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="videoFile">...or Upload Video File</label>
        <input type="file" id="videoFile" onChange={(e) => setVideoFile(e.target.files[0])} className="w-full" accept="video/*" />
      </div>

      <hr className="my-6" />
      <h3 className="text-xl font-semibold mb-4">Contact & Order Info</h3>
      <AdminInput label="WhatsApp Number (e.g., 911234567890)" id="whatsappNumber" name="whatsappNumber" value={formState.whatsappNumber || ''} onChange={handleChange} />
      <AdminInput label="Phone Number" id="phone" name="phone" value={formState.phone || ''} onChange={handleChange} />
      <AdminInput label="Email Address" id="email" name="email" value={formState.email || ''} onChange={handleChange} type="email" />
      <AdminTextarea label="Address" id="address" name="address" value={formState.address || ''} onChange={handleChange} />
      <AdminInput label="Google Maps Embed URL" id="mapEmbedUrl" name="mapEmbedUrl" value={formState.mapEmbedUrl || ''} onChange={handleChange} />
      
      <div className="mt-6">
        <AdminButton type="submit" isLoading={isSaving || isUploading}>
          Save Settings
        </AdminButton>
      </div>
    </form>
  );
};

// Category Manager
const CategoryManager = ({ categories }) => {
  const [name, setName] = useState('');
  const [file, setFile] = useState(null);
  const [message, setMessage] = useState('');
  const { uploadFile, isUploading } = useFileUpload();

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!name || !file) {
      setMessage('Please provide a name and an image.');
      return;
    }
    setMessage('');
    
    const imageUrl = await uploadFile(file);
    if (imageUrl) {
      try {
        await addDoc(collection(db, categoriesPath), { name, imageUrl });
        setMessage('Category added!');
        setName('');
        setFile(null);
        e.target.reset(); // Reset file input
      } catch (err) {
        console.error(err);
        setMessage('Error adding category.');
      }
    } else {
      setMessage('File upload failed.');
    }
  };
  
  const handleDelete = async (id) => {
    if (window.confirm('Are you sure you want to delete this category?')) {
      try {
        await deleteDoc(doc(db, categoriesPath, id));
      } catch (err) {
        console.error(err);
        alert('Could not delete category.');
      }
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
      <form onSubmit={handleSubmit} className="md:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
        <h2 className="text-2xl font-semibold mb-6">Add New Category</h2>
        {message && <p className="mb-4">{message}</p>}
        <AdminInput label="Category Name" id="catName" value={name} onChange={(e) => setName(e.target.value)} required />
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="catImage">Category Image</label>
          <input type="file" id="catImage" onChange={(e) => setFile(e.target.files[0])} className="w-full" required accept="image/*" />
        </div>
        <AdminButton type="submit" isLoading={isUploading}>Add Category</AdminButton>
      </form>
      
      <div className="md:col-span-2">
        <h2 className="text-2xl font-semibold mb-6">Existing Categories</h2>
        <div className="space-y-4">
          {categories.map(cat => (
            <div key={cat.id} className="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
              <div className="flex items-center space-x-4">
                <img src={cat.imageUrl} alt={cat.name} className="w-16 h-16 rounded-lg object-cover" />
                <span className="text-lg font-medium">{cat.name}</span>
              </div>
              <button
                onClick={() => handleDelete(cat.id)}
                className="text-red-600 hover:text-red-800"
              >
                Delete
              </button>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// Product Manager
const ProductManager = ({ products, categories }) => {
  const [formState, setFormState] = useState({
    name: '',
    description: '',
    price: '',
    categoryId: '',
    isFeatured: false,
  });
  const [file, setFile] = useState(null);
  const [message, setMessage] = useState('');
  const { uploadFile, isUploading } = useFileUpload();
  
  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormState(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formState.name || !formState.price || !formState.categoryId || !file) {
      setMessage('Please fill all fields and select an image.');
      return;
    }
    setMessage('');
    
    const imageUrl = await uploadFile(file);
    if (imageUrl) {
      try {
        await addDoc(collection(db, productsPath), { 
          ...formState, 
          price: parseFloat(formState.price),
          imageUrl 
        });
        setMessage('Product added!');
        setFormState({ name: '', description: '', price: '', categoryId: '', isFeatured: false });
        setFile(null);
        e.target.reset();
      } catch (err) {
        console.error(err);
        setMessage('Error adding product.');
      }
    } else {
      setMessage('File upload failed.');
    }
  };
  
  const handleDelete = async (id) => {
    if (window.confirm('Are you sure you want to delete this product?')) {
      try {
        await deleteDoc(doc(db, productsPath, id));
      } catch (err) {
        console.error(err);
        alert('Could not delete product.');
      }
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
      <form onSubmit={handleSubmit} className="md:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
        <h2 className="text-2xl font-semibold mb-6">Add New Product</h2>
        {message && <p className="mb-4">{message}</p>}
        <AdminInput label="Product Name" id="prodName" name="name" value={formState.name} onChange={handleChange} required />
        <AdminTextarea label="Description" id="prodDesc" name="description" value={formState.description} onChange={handleChange} />
        <AdminInput label="Price" id="prodPrice" name="price" value={formState.price} onChange={handleChange} type="number" step="0.01" required />
        
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="prodCat">Category</label>
          <select id="prodCat" name="categoryId" value={formState.categoryId} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm" required>
            <option value="">Select a category</option>
            {categories.map(cat => (
              <option key={cat.id} value={cat.id}>{cat.name}</option>
            ))}
          </select>
        </div>
        
        <div className="mb-4">
          <label className="flex items-center space-x-2" htmlFor="prodFeatured">
            <input type="checkbox" id="prodFeatured" name="isFeatured" checked={formState.isFeatured} onChange={handleChange} className="rounded" />
            <span>Mark as Featured</span>
          </label>
        </div>
        
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="prodImage">Product Image</label>
          <input type="file" id="prodImage" onChange={(e) => setFile(e.target.files[0])} className="w-full" required accept="image/*" />
        </div>
        
        <AdminButton type="submit" isLoading={isUploading}>Add Product</AdminButton>
      </form>
      
      <div className="md:col-span-2">
        <h2 className="text-2xl font-semibold mb-6">Existing Products</h2>
        <div className="space-y-4">
          {products.map(prod => (
            <div key={prod.id} className="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
              <div className="flex items-center space-x-4">
                <img src={prod.imageUrl} alt={prod.name} className="w-16 h-16 rounded-lg object-cover" />
                <div>
                  <span className="text-lg font-medium">{prod.name}</span>
                  <p className="text-sm text-gray-500">₹{prod.price}</p>
                </div>
              </div>
              <button
                onClick={() => handleDelete(prod.id)}
                className="text-red-600 hover:text-red-800"
              >
                Delete
              </button>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};